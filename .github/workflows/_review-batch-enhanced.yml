name: Review Batch Enhanced

on:
  workflow_call:
    inputs:
      batch_json:
        type: string
        required: true
      model:
        type: string
        required: true
      max_diff_lines:
        type: string
        required: true
      full_file_threshold_lines:
        type: string
        required: true
      window_before:
        type: string
        required: true
      window_after:
        type: string
        required: true
      merge_gap_tolerance:
        type: string
        required: true
      max_windowed_lines:
        type: string
        required: true
      policy_path:
        type: string
        required: false
      policy_found:
        type: string
        required: false
      policy_scope:
        type: string
        required: false
      control_repo_ref:
        type: string
        required: true
    secrets:
      GEMINI_API_KEY:
        required: true
      PAT_TOKEN:
        required: true

jobs:
  review:
    runs-on: ubuntu-latest
    steps:


      - name: Checkout repo (full history for git show)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout org .github control repo (optional)
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/.github
          ref: ${{ inputs.control_repo_ref }}
          path: __org_control
          fetch-depth: 1
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI (retry)
        shell: bash
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            if npm install -g @google/gemini-cli; then exit 0; fi
            echo "npm install failed, retrying ($((3-i)) left)"; sleep 5
          done
          exit 1

      - name: Process batch
        uses: softlink-dev/.github/.github/actions/process-batch-enhanced@main
        with:
          batch_json: ${{ inputs.batch_json }}
          model: ${{ inputs.model }}
          max_diff_lines: ${{ inputs.max_diff_lines }}
          full_file_threshold_lines: ${{ inputs.full_file_threshold_lines }}
          window_before: ${{ inputs.window_before }}
          window_after: ${{ inputs.window_after }}
          merge_gap_tolerance: ${{ inputs.merge_gap_tolerance }}
          max_windowed_lines: ${{ inputs.max_windowed_lines }}
          policy_found: ${{ inputs.policy_found }}
          policy_scope: ${{ inputs.policy_scope }}
          policy_path: ${{ inputs.policy_path }}
          pr_number: ${{ github.event.pull_request.number }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Validate workspace before upload
        shell: bash
        run: |
          echo "üîç Validating workspace before upload..."
          WORKSPACE_DIR=".github/review-work/PR-${{ github.event.pull_request.number }}"
          
          # Check if workspace directory exists
          if [ ! -d "$WORKSPACE_DIR" ]; then
            echo "‚ùå ERROR: Workspace directory $WORKSPACE_DIR does not exist"
            exit 1
          fi
          
          # Check if workspace contains expected files
          REVIEW_FILES=$(find "$WORKSPACE_DIR" -name "*.md" -type f | grep -v summary.json | wc -l)
          if [ "$REVIEW_FILES" -eq 0 ]; then
            echo "‚ö†Ô∏è  WARNING: No review files found in workspace"
          else
            echo "‚úÖ Found $REVIEW_FILES review files in workspace"
          fi
          
          # Check for summary.json
          if [ ! -f "$WORKSPACE_DIR/summary.json" ]; then
            echo "‚ùå ERROR: summary.json not found in workspace"
            exit 1
          fi
          
          # Check for prompt-log directory
          if [ ! -d "$WORKSPACE_DIR/prompt-log" ]; then
            echo "‚ö†Ô∏è  WARNING: prompt-log directory not found in workspace"
          else
            PROMPT_COUNT=$(find "$WORKSPACE_DIR/prompt-log" -name "*.md" -type f | wc -l)
            echo "‚úÖ Found $PROMPT_COUNT debug prompt files"
          fi
          
          echo "‚úÖ Workspace validation passed - ready for upload"

      - name: Upload batch review artifact
        uses: actions/upload-artifact@v4
        with:
          name: review-batch-${{ fromJson(inputs.batch_json).id }}
          path: .github/review-work/PR-${{ github.event.pull_request.number }}/
          if-no-files-found: warn

      - name: Validate batch review artifact structure
        shell: bash
        run: |
          echo "üîç Validating batch review artifact structure..."
          
          # Safely get batch ID for context with error handling
          BATCH_ID=$(echo '${{ inputs.batch_json }}' | jq -r '.id // "unknown"' 2>/dev/null || echo 'unknown')
          echo "Validating batch $BATCH_ID"
          
          # Check workspace directory
          WORKSPACE_DIR=".github/review-work/PR-${{ github.event.pull_request.number }}"
          echo "Checking workspace directory: $WORKSPACE_DIR"
          
          if [ ! -d "$WORKSPACE_DIR" ]; then
            echo "‚ùå ERROR: Workspace directory not found: $WORKSPACE_DIR"
            exit 1
          fi
          
          # Check for expected files in workspace directory
          echo "Workspace directory contents:"
          ls -la "$WORKSPACE_DIR" || echo "‚ö†Ô∏è  WARNING: ls command failed"
          
          # Check for summary.json
          if [ ! -f "$WORKSPACE_DIR/summary.json" ]; then
            echo "‚ùå ERROR: summary.json not found in workspace: $WORKSPACE_DIR/summary.json"
            exit 1
          fi
          
          # Safely check if jq is available
          if ! command -v jq &> /dev/null; then
            echo "‚ö†Ô∏è  WARNING: jq not available, skipping JSON validation"
            echo "‚úÖ Summary.json exists (validation skipped)"
            TOTAL="unknown"
            PROCESSED="unknown"
            BATCH_ID_IN_SUMMARY="unknown"
          else
            # Validate summary.json structure
            if ! jq -e '.' "$WORKSPACE_DIR/summary.json" > /dev/null 2>&1; then
              echo "‚ùå ERROR: summary.json is not valid JSON"
              exit 1
            fi
            
            # Check summary.json fields with error handling
            TOTAL=$(jq -r '.total // 0' "$WORKSPACE_DIR/summary.json" 2>/dev/null || echo 'error')
            PROCESSED=$(jq -r '.processed // 0' "$WORKSPACE_DIR/summary.json" 2>/dev/null || echo 'error')
            BATCH_ID_IN_SUMMARY=$(jq -r '.batch_id // "unknown"' "$WORKSPACE_DIR/summary.json" 2>/dev/null || echo 'error')
          fi
          
          echo "‚úÖ Summary.json validation passed:"
          echo "   - Total files: $TOTAL"
          echo "   - Processed files: $PROCESSED"
          echo "   - Batch ID: $BATCH_ID_IN_SUMMARY"
          
          # Check for review files (should be .md files, not summary.json)
          REVIEW_FILES=$(find "$WORKSPACE_DIR" -name "*.md" -type f | grep -v summary.json | wc -l 2>/dev/null || echo '0')
          echo "‚úÖ Found $REVIEW_FILES review files"
          
          # Check for prompt-log directory
          if [ -d "$WORKSPACE_DIR/prompt-log" ]; then
            PROMPT_COUNT=$(find "$WORKSPACE_DIR/prompt-log" -name "*.md" -type f | wc -l 2>/dev/null || echo '0')
            echo "‚úÖ Found $PROMPT_COUNT debug prompt files in $WORKSPACE_DIR/prompt-log/"
          else
            echo "‚ö†Ô∏è  WARNING: prompt-log directory not found in workspace"
          fi
          
          # Validate flat structure (no nested reviews directory)
          if [ -d "$WORKSPACE_DIR/reviews" ]; then
            echo "‚ùå ERROR: Found nested 'reviews' directory - expected flat structure"
            exit 1
          fi
          
          echo "‚úÖ Batch review artifact validation passed"
